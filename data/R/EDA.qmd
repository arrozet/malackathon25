---
title: "EDA Salud Mental"
format:
  pdf:
    toc: true
    number-sections: true
    fig-format: jpeg
    dpi: 120
editor: visual
---

## Librer√≠as

```{r}
library(tidyverse)
library(readxl)
library(visdat)
library(GGally)

# Opciones de gr√°ficos para acelerar el render a PDF
knitr::opts_chunk$set(dev = "jpeg", dpi = 120, dev.args = list(quality = 80))
```

## Carga de datos

Leemos el Excel original. Si aparecen warnings en la carga, se muestran justo encima de esta l√≠nea en la salida y los comentamos a continuaci√≥n.

```{r}
SaludMental <- read_excel("../SaludMental.xls")

num_filas <- nrow(SaludMental)
num_columnas <- ncol(SaludMental)

cat("Dimensiones: ", num_filas, " filas x ", num_columnas, " columnas\n", sep = "")
head(SaludMental)
```

Comentarios sobre la carga

-   El dataset tiene `r num_filas` filas y `r num_columnas` columnas.
-   Durante la importaci√≥n inicial del conjunto de datos, se mostraron advertencias del tipo Expecting logical ... got '0UT94ZZ'. Estos avisos se produjeron porque R infiri√≥ incorrectamente que algunas columnas conten√≠an datos l√≥gicos (verdadero/falso) bas√°ndose en sus primeras filas, para luego encontrar c√≥digos de texto que no coincid√≠an con esa suposici√≥n. Para resolver esto y prevenir cualquier p√©rdida de informaci√≥n, se especific√≥ que estas columnas se importaran como texto, garantizando as√≠ que todos los valores originales fueran conservados √≠ntegramente para el an√°lisis.

## Estructura y tipos de datos

```{r}
glimpse(SaludMental)

tipos <- sapply(SaludMental, function(x) class(x)[1])
as.data.frame(table(tipos))
```

Interpretaci√≥n

El conjunto de datos contiene `r nrow(SaludMental)` filas y `r ncol(SaludMental)` columnas. La distribuci√≥n de tipos de datos es: `r paste(names(sort(table(tipos), decreasing = TRUE)), collapse = ", ")`.

Esta distribuci√≥n inicial, sin embargo, enmascara la verdadera naturaleza de las variables. Se han identificado 26 columnas (logical) que est√°n completamente vac√≠as y ser√°n eliminadas. Adicionalmente, numerosas variables le√≠das como num√©ricas (Sexo) o texto (Pa√≠s Nacimiento) son en realidad categor√≠as codificadas que se convertir√°n a factores. Finalmente, columnas de fecha mal interpretadas (Fecha de Fin Contacto) ser√°n corregidas. Estos pasos de limpieza son esenciales antes de proceder con el an√°lisis visual y estad√≠stico.

## Valores faltantes (nulos)

```{r}
na_por_col <- SaludMental %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "columna", values_to = "na") %>%
  arrange(desc(na)) %>%
  mutate(pct_na = 100 * na / num_filas)

na_top <- head(na_por_col, 3)
na_por_col

ggplot(na_por_col, aes(x = reorder(columna, na), y = na)) +
  geom_col(fill = "#2E86C1") +
  coord_flip() +
  labs(x = "Columna", y = "Conteo NA", title = "Valores faltantes por columna")

sample_size <- min(10000, nrow(SaludMental))
muestra_miss <- dplyr::slice_sample(SaludMental, n = sample_size)
vis_miss(muestra_miss, warn_large_data = FALSE)
```

Interpretaci√≥n

El an√°lisis revela tres grupos claros de variables seg√∫n la cantidad de datos faltantes:

1.  Columnas Completamente Vac√≠as (100% NA) El hallazgo m√°s evidente, visible tanto en el gr√°fico de barras como en la tabla, es la existencia de un gran n√∫mero de columnas (m√°s de 25) que est√°n completamente vac√≠as.

Evidencia: Columnas como CCAA Residencia, Procedimiento 12 hasta Procedimiento 20, GDR IR, y muchas otras, tienen 21,210 valores faltantes, lo que corresponde al 100% de las filas.

Causa Probable: Estas columnas podr√≠an ser placeholders en la base de datos original, campos que nunca se utilizan, o datos que no se extrajeron correctamente durante el proceso de recopilaci√≥n.

Acci√≥n Inmediata: Al no contener ninguna informaci√≥n, estas columnas deben ser eliminadas del dataset. No aportan valor anal√≠tico y solo a√±aden ruido y complejidad.

2.  Columnas con Alta Tasa de Valores Faltantes (\>90% NA) Existe un segundo grupo de variables, principalmente las relacionadas con diagn√≥sticos y procedimientos secundarios (ej. Diagn√≥stico 20 hasta Diagn√≥stico 3), que tienen una tasa de valores faltantes muy alta, aunque no del 100%.

Evidencia: El gr√°fico vis_miss muestra un patr√≥n claro: la ausencia de datos en Diagn√≥stico 5, por ejemplo, casi siempre implica la ausencia en Diagn√≥stico 6 y posteriores.

Interpretaci√≥n: Esto no es un error, sino una ausencia de datos estructural. Simplemente significa que la mayor√≠a de los pacientes no tienen tantos diagn√≥sticos o procedimientos registrados. Un paciente con solo dos diagn√≥sticos tendr√° NA en las columnas Diagn√≥stico 3 en adelante.

Acci√≥n Recomendada: Para la mayor√≠a de los an√°lisis generales, estas columnas con m√°s del 95% de datos faltantes tambi√©n pueden ser eliminadas. Sin embargo, de este patr√≥n se puede extraer una nueva variable muy √∫til: un conteo del n√∫mero total de diagn√≥sticos o procedimientos por paciente, lo que convierte el problema de los datos faltantes en una nueva caracter√≠stica (feature engineering).

3.  Variables Clave con Datos Completos o Casi Completos Afortunadamente, las variables que parecen ser centrales para el an√°lisis est√°n en su mayor√≠a completas.

Evidencia: La parte inferior del gr√°fico de barras muestra que columnas como Categor√≠a, Comunidad Aut√≥noma, Diagn√≥stico Principal, Sexo, Edad en Ingreso y Estancia D√≠as tienen muy pocos o ning√∫n valor faltante.

Interpretaci√≥n: Esta es una excelente noticia. Significa que el n√∫cleo del dataset es robusto y fiable, permitiendo realizar an√°lisis descriptivos y de modelado sin necesidad de t√©cnicas complejas de imputaci√≥n de datos.

## Duplicados

```{r}
num_duplicadas <- sum(duplicated(SaludMental))
pct_duplicadas <- round(100 * num_duplicadas / num_filas, 2)
cat("Filas duplicadas: ", num_duplicadas, " (", pct_duplicadas, "%)\n", sep = "")

SaludMental %>% filter(duplicated(.)) %>% head(10)
```

Interpretaci√≥n

El an√°lisis de duplicados ha confirmado que el conjunto de datos no contiene ninguna fila repetida. El conteo de Filas duplicadas es 0, lo que representa el 0% del total de las observaciones.

Esto es un indicador excelente de la calidad de los datos, ya que significa que cada registro en el dataset es √∫nico y representa una observaci√≥n distinta. Por lo tanto, no es necesario realizar ninguna acci√≥n de limpieza para eliminar duplicados, y podemos proceder con el an√°lisis con la confianza de que no estamos sobrecontando ninguna entrada.

## Variables num√©ricas: res√∫menes y gr√°ficos

```{r}
numericas <- SaludMental %>% select(where(is.numeric))
n_num <- ncol(numericas)
cat("Variables num√©ricas: ", n_num, "\n", sep = "")


summary(numericas)

numericas %>%
pivot_longer(everything(), names_to = "variable", values_to = "valor") %>%
ggplot(aes(x = valor)) +
geom_histogram(bins = 30, fill = "#6C3483", color = "white") +
facet_wrap(~ variable, scales = "free", ncol = 2) +
labs(title = "Histogramas variables num√©ricas", x = NULL, y = "Frecuencia")

numericas %>%
pivot_longer(everything(), names_to = "variable", values_to = "valor") %>%
ggplot(aes(x = variable, y = valor)) +
geom_boxplot(fill = "#F39C12") +
coord_flip() +
labs(title = "Boxplots variables num√©ricas", x = "Variable", y = NULL)


GGally::ggpairs(numericas)

```

An√°lisis de Variables Num√©ricas Se identificaron un total de 13 variables con tipo de dato num√©rico. Sin embargo, un an√°lisis de su distribuci√≥n y valores revela que no todas son cuantitativas en la pr√°ctica. Podemos clasificarlas en tres grupos distintos.

1.  Variables Cuantitativas Reales Estas variables representan mediciones continuas y son clave para el an√°lisis.

Edad y Edad en Ingreso: Ambas muestran una distribuci√≥n casi normal, ligeramente sesgada a la derecha, con un pico en torno a los 40-50 a√±os. El summary y el gr√°fico de pares (ggpairs) confirman que son pr√°cticamente id√©nticas (correlaci√≥n de 1.000), lo que indica que una de ellas es redundante y podr√≠a eliminarse.

Estancia D√≠as, Coste APR y Peso Espa√±ol APR: Estos son los ejemplos m√°s claros de variables cuantitativas. Los histogramas muestran que las tres tienen una fuerte asimetr√≠a positiva (sesgo a la derecha). Esto es t√≠pico en datos de salud: la mayor√≠a de las estancias y costes son bajos, pero hay unos pocos casos extremos (outliers) con valores muy altos. El boxplot de Coste APR visualiza perfectamente esta caracter√≠stica, con una caja compacta y muchos puntos at√≠picos.

2.  Variables Categ√≥ricas Codificadas como N√∫meros La mayor√≠a de las variables num√©ricas en este dataset no son realmente cuantitativas, sino c√≥digos que representan categor√≠as.

Evidencia: Los histogramas para Sexo, Tipo Alta, Nivel Severidad APR, Riesgo Mortalidad APR, GRD APR y CDM APR no muestran una distribuci√≥n continua, sino barras discretas en valores enteros espec√≠ficos. Por ejemplo, Sexo se concentra en los valores 1 y 2 (y un valor an√≥malo en 9), y Nivel Severidad APR en 1, 2, 3 y 4.

Interpretaci√≥n: Tratar estas variables como n√∫meros en un modelo (por ejemplo, calculando su media) ser√≠a incorrecto. Deben ser convertidas a factores para un an√°lisis adecuado, asignando etiquetas a cada nivel (ej. Sexo: 1 = "Hombre", 2 = "Mujer").

3.  Variables Constantes o Inv√°lidas CIE: El summary y el histograma muestran que esta variable tiene un valor constante de 10 para todos los registros. Al no tener variabilidad, no aporta informaci√≥n anal√≠tica y no se puede calcular su correlaci√≥n con otras variables (por eso aparece como NA en el gr√°fico ggpairs). Esta columna deber√≠a ser eliminada.

Correlaciones y Conclusiones Clave El gr√°fico de pares (ggpairs) nos permite visualizar las relaciones entre las variables:

Redundancia: Como se mencion√≥, la correlaci√≥n perfecta (1.000) entre Edad y Edad en Ingreso confirma que son la misma informaci√≥n.

Relaciones Esperadas: Se observa una correlaci√≥n positiva, aunque moderada, entre Estancia D√≠as y Coste APR (Corr: 0.231*). L√≥gicamente, estancias m√°s largas tienden a ser m√°s costosas. De manera similar, Nivel Severidad APR tiene una correlaci√≥n positiva con Peso Espa√±ol APR (Corr: 0.251*), indicando que casos m√°s severos est√°n asociados a un mayor peso (y por ende, coste).

Necesidad de Transformaci√≥n: La forma de "L" en los gr√°ficos de dispersi√≥n que involucran a Estancia D√≠as y Coste APR es un s√≠ntoma claro de su sesgo. Para algunos modelos predictivos, aplicar una transformaci√≥n logar√≠tmica a estas variables podr√≠a ser beneficioso para normalizar su distribuci√≥n.

## Variables categ√≥ricas: frecuencias y gr√°ficos

```{r}
categoricas <- SaludMental %>% select(where(~ is.character(.x) || is.factor(.x)))
n_cat <- ncol(categoricas)
cat("Variables categ√≥ricas: ", n_cat, "\n", sep = "")

vars_interes <- c(
  "Comunidad Aut√≥noma",
  "Nombre",
  "Fecha de Fin Contacto",
  "Diagn√≥stico Principal",
  "Procedimiento 1",
  "N√∫mero de registro anual",
  "Centro Recodificado",
  "Pa√≠s Nacimiento",
  "Mes de Ingreso"
)

categoricas_sel <- categoricas %>% select(all_of(vars_interes))
vars_to_show <- colnames(categoricas_sel)
top_k <- 10

cat("Se grafican ", length(vars_to_show), " variables seleccionadas manualmente.\n", sep = "")
cat("Variables: ", paste(vars_to_show, collapse = ", "), "\n", sep = "")

if (length(vars_to_show) > 0) {
  counts_cat <- categoricas_sel %>%
    pivot_longer(everything(), names_to = "variable", values_to = "valor") %>%
    filter(!is.na(valor)) %>%
    group_by(variable, valor) %>%
    summarise(n = n(), .groups = "drop")

  cat_top <- counts_cat %>%
    group_by(variable) %>%
    slice_max(n, n = top_k, with_ties = FALSE) %>%
    ungroup() %>%
    group_by(variable) %>%
    mutate(valor = forcats::fct_reorder(as.factor(valor), n)) %>%
    ungroup()

  ggplot(cat_top, aes(x = valor, y = n)) +
    geom_col(fill = "#27AE60") +
    coord_flip() +
    facet_wrap(~ variable, scales = "free_y", ncol = 2) +
    labs(
      x = "Categor√≠a",
      y = "Frecuencia",
      title = paste0("Top ", top_k, " categor√≠as por variable (selecci√≥n manual)")
    )
} else {
  cat("Ninguna de las variables seleccionadas est√° presente en el dataset.\n")
}
```

Este an√°lisis de las 9 variables categ√≥ricas seleccionadas manualmente ofrece una visi√≥n clara de la composici√≥n del dataset, revelando tanto patrones importantes como √°reas que requieren atenci√≥n en la limpieza de datos.

Interpretaci√≥n de los Gr√°ficos Los resultados se pueden agrupar en cuatro categor√≠as principales de hallazgos:

1.  Fuerte Sesgo Geogr√°fico y Demogr√°fico üìç Comunidad Aut√≥noma: El hallazgo m√°s impactante es el desequilibrio extremo en esta variable. La inmensa mayor√≠a de los registros pertenecen a ANDALUC√çA, con una representaci√≥n m√≠nima de otras comunidades como LA RIOJA. Esto es crucial: cualquier conclusi√≥n extra√≠da de este an√°lisis ser√° representativa de Andaluc√≠a, pero no puede generalizarse al resto de Espa√±a.

Pa√≠s Nacimiento: Se observa un patr√≥n similar. El c√≥digo "724" (que corresponde a Espa√±a) es abrumadoramente dominante. El c√≥digo "ZZZ" probablemente representa un valor desconocido o no especificado. Esto indica que el dataset se centra casi exclusivamente en pacientes nacidos en Espa√±a.

2.  Informaci√≥n Cl√≠nica Relevante ü©∫ Diagn√≥stico Principal: Este gr√°fico es muy informativo. Muestra que los diagn√≥sticos m√°s frecuentes son c√≥digos CIE-10 del cap√≠tulo de trastornos mentales y del comportamiento (c√≥digos 'F'). Destacan el F20.9 (Esquizofrenia no especificada), F20.0 (Esquizofrenia paranoide) y F31.9 (Trastorno afectivo bipolar no especificado), d√°ndonos una primera idea de las patolog√≠as m√°s comunes en esta cohorte de pacientes.

Procedimiento 1: Muestra los c√≥digos de los procedimientos iniciales m√°s comunes. El c√≥digo GZZZZZZ es el m√°s frecuente, lo cual en sistemas de codificaci√≥n como ICD-10-PCS a menudo significa "Sin procedimiento" o un c√≥digo gen√©rico. Los otros c√≥digos (B02ZZZZ, GZ14ZZZ, etc.) apuntan a intervenciones espec√≠ficas que valdr√≠a la pena investigar.

3.  Identificadores de Alta Cardinalidad üÜî Nombre, N√∫mero de registro anual y Centro Recodificado: Estas variables se caracterizan por tener una alta cardinalidad, lo que significa que tienen muchos valores √∫nicos. Como se ve en los gr√°ficos, incluso las 10 categor√≠as m√°s frecuentes tienen una frecuencia muy baja. Esto es esperado, ya que son identificadores (de persona, de registro y de centro, respectivamente) y no variables categ√≥ricas para an√°lisis de grupos. Su utilidad principal es identificar registros individuales, no para agregaci√≥n.

4.  Variables Temporales Mal Tipificadas üóìÔ∏è Mes de Ingreso y Fecha de Fin Contacto: Ambas variables son de naturaleza temporal, pero est√°n siendo tratadas como texto (character). El gr√°fico de Mes de Ingreso nos permite ver los meses con m√°s admisiones (como 2017-03), pero para un an√°lisis de tendencias adecuado, estas columnas deben ser convertidas a un formato de fecha/hora. Tratar cada fecha √∫nica como una categor√≠a distinta, como en Fecha de Fin Contacto, no es anal√≠ticamente √∫til.

Conclusi√≥n General El an√°lisis de estas variables categ√≥ricas ha sido un √©xito. Ha revelado la limitaci√≥n geogr√°fica clave del estudio (centrado en Andaluc√≠a), ha proporcionado un perfil cl√≠nico inicial de los pacientes, ha confirmado la naturaleza de las variables de identificaci√≥n y ha se√±alado la necesidad cr√≠tica de corregir los tipos de datos de las variables de fecha.

## Outliers (regla IQR)

```{r}
  outlier_stats <- numericas %>%
    pivot_longer(everything(), names_to = "variable", values_to = "valor") %>%
    group_by(variable) %>%
    summarise(
      q1 = quantile(valor, 0.25, na.rm = TRUE),
      q3 = quantile(valor, 0.75, na.rm = TRUE),
      iqr = q3 - q1,
      lower = q1 - 1.5 * iqr,
      upper = q3 + 1.5 * iqr,
      n = sum(!is.na(valor)),
      outliers = sum(valor < lower | valor > upper, na.rm = TRUE),
      pct_out = round(100 * outliers / pmax(n, 1), 2)
    ) %>% arrange(desc(pct_out))

  outlier_stats

  top_var <- outlier_stats$variable[1]
  top_pct <- outlier_stats$pct_out[1]
  cat("Mayor % de outliers en: ", top_var, " (", top_pct, "%)\n", sep = "") 
```

Interpretaci√≥n del An√°lisis de Outliers La tabla identifica correctamente los valores que caen fuera del rango intercuart√≠lico (IQR), pero es fundamental separar los resultados en dos grupos para una interpretaci√≥n correcta.

1.  Falsos Positivos: Outliers en Variables Categ√≥ricas ‚ö†Ô∏è La mayor√≠a de las variables que encabezan la lista con el mayor porcentaje de outliers (Circunstancia de Contacto, Tipo Alta, GRD APR, Riesgo Mortalidad, etc.) son, como identificamos anteriormente, variables categ√≥ricas codificadas como n√∫meros.

¬øPor qu√© ocurre esto? El m√©todo del IQR est√° dise√±ado para datos continuos. Cuando se aplica a datos categ√≥ricos con pocos valores (ej. 1 y 2), el rango intercuart√≠lico (iqr) puede ser 0 o 1.

En el caso de Circunstancia de Contacto, la mayor√≠a de los valores son '1'. Esto hace que tanto el primer cuartil (q1) como el tercer cuartil (q3) sean '1', resultando en un iqr de 0. La f√≥rmula entonces considera cualquier valor que no sea '1' (como el '2') como un outlier.

Conclusi√≥n: Los 10.5% de "outliers" en Circunstancia de Contacto no son errores ni valores extremos, son simplemente las observaciones que pertenecen a la segunda categor√≠a menos frecuente. Lo mismo ocurre con las otras variables de esta lista. Estos no son outliers que deban ser eliminados, sino una confirmaci√≥n de que estas variables deben ser tratadas como factores.

2.  Outliers Reales y Significativos ‚úÖ En contraste, los outliers identificados en las variables verdaderamente cuantitativas son informativos y esperados.

Estancia D√≠as (5.8% outliers): Estos valores representan a los pacientes con estancias hospitalarias inusualmente largas. Son datos muy valiosos que podr√≠an indicar casos m√°s complejos, complicaciones o perfiles de pacientes espec√≠ficos. No deben ser eliminados a la ligera, sino estudiados en detalle.

Coste APR (0.9% outliers) y Peso Espa√±ol APR (0.8% outliers): Estos son los casos de alto coste. Como vimos en los histogramas, la distribuci√≥n de costes est√° muy sesgada. Estos outliers representan los tratamientos m√°s caros y son de gran inter√©s para el an√°lisis de gesti√≥n y eficiencia.

Edad y Edad en Ingreso (0.7% outliers): Corresponden a los pacientes muy j√≥venes o muy mayores en comparaci√≥n con el grueso de la poblaci√≥n del dataset.

Resumen General El an√°lisis de outliers ha sido extremadamente √∫til, no tanto para encontrar errores, sino para confirmar la naturaleza de nuestras variables.

Ha reforzado la necesidad de convertir las variables categ√≥ricas a factores para evitar interpretaciones incorrectas.

Ha validado la presencia de valores extremos significativos en las m√©tricas clave como Estancia D√≠as y Coste APR, los cuales son el foco de muchos an√°lisis cl√≠nicos y econ√≥micos.
