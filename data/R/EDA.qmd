---
title: "EDA Salud Mental"
format:
  pdf:
    toc: true
    number-sections: true
    fig-format: jpeg
    dpi: 120
editor: visual
---

## Librerías

```{r}
library(tidyverse)
library(readxl)
library(visdat)
library(GGally)

# Opciones de gráficos para acelerar el render a PDF
knitr::opts_chunk$set(
  dev = "png",
  dpi = 200,
  fig.width = 11,
  fig.height = 6.5,
  out.width = "100%"
)
```

## Carga de datos

Leemos el Excel original. Si aparecen warnings en la carga, se muestran justo encima de esta línea en la salida y los comentamos a continuación.

```{r}
SaludMental <- read_excel("../SaludMental.xls")

num_filas <- nrow(SaludMental)
num_columnas <- ncol(SaludMental)

cat("Dimensiones: ", num_filas, " filas x ", num_columnas, " columnas\n", sep = "")
head(SaludMental)
```

### Comentarios sobre la carga

- El dataset tiene `r num_filas` filas y `r num_columnas` columnas.
- Durante la importación inicial del conjunto de datos aparecieron advertencias del tipo *Expecting logical ... got '0UT94ZZ'*. R infirió de forma incorrecta que algunas columnas eran lógicas y, al encontrar códigos de texto, generó el aviso. Se forzó la importación de estas columnas como texto para preservar todos los valores originales y evitar pérdidas de información.

## Estructura y tipos de datos

```{r}
glimpse(SaludMental)

tipos <- sapply(SaludMental, function(x) class(x)[1])
as.data.frame(table(tipos))
```

### Interpretación

**Panorama general**  Se identificaron 13 variables numéricas, aunque muchas representan códigos categóricos. Se clasifican en tres grupos:

**1. Métricas cuantitativas reales**
- `Edad` y `Edad en Ingreso` muestran distribuciones casi normales y correlación 1.0; una puede eliminarse por redundancia.
- `Estancia Días`, `Coste APR` y `Peso Español APR` presentan fuerte asimetría positiva con casos extremos relevantes para gestión clínica.

**2. Códigos categóricos codificados como números**
- `Sexo`, `Tipo Alta`, `Nivel Severidad APR`, `Riesgo Mortalidad APR`, `GRD APR`, `CDM APR` y similares se concentran en pocos valores enteros.
- Deben convertirse en factores con etiquetas descriptivas antes de cualquier modelado.

**3. Variables constantes o sin valor analítico**
- `CIE` es constante (valor 10) y no aporta información.

**Relaciones clave**
- `Estancia Días` y `Coste APR` correlacionan moderadamente (0.231*), lo que respalda su relación esperada.
- `Nivel Severidad APR` y `Peso Español APR` tienen correlación positiva (0.251*), reflejando mayor peso en casos severos.
- La forma en “L” de las dispersiones sugiere evaluar transformaciones logarítmicas para distribuciones sesgadas.

## Valores faltantes (nulos)

```{r, fig.width = 11, fig.height = 7}
na_por_col <- SaludMental %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "columna", values_to = "na") %>%
  arrange(desc(na)) %>%
  mutate(pct_na = 100 * na / num_filas)

na_top <- head(na_por_col, 3)
na_por_col

na_plot <- ggplot(na_por_col, aes(x = reorder(columna, na), y = na)) +
  geom_col(fill = "#2E86C1") +
  coord_flip() +
  labs(x = "Columna", y = "Conteo NA", title = "Valores faltantes por columna") +
  theme_minimal(base_size = 13)

na_plot

sample_size <- min(10000, nrow(SaludMental))
muestra_miss <- dplyr::slice_sample(SaludMental, n = sample_size)
vis_miss(muestra_miss, warn_large_data = FALSE)
```

### Interpretación

El análisis revela tres grupos claros de variables según la cantidad de datos faltantes:

**1. Columnas completamente vacías (100% NA)**
- Ejemplos: `CCAA Residencia`, `Procedimiento 12`-`Procedimiento 20`, `GDR IR`.
- Situación: cada variable acumula 21 210 valores faltantes, por lo que no aporta información.
- Acción: eliminar estas columnas para reducir ruido y simplificar el modelo de datos.

**2. Columnas con alta tasa de valores faltantes (>90% NA)**
- Ejemplos: `Diagnóstico 3`-`Diagnóstico 20` y procedimientos secundarios.
- Lectura: la mayoría de pacientes no alcanza tantos registros; los NA reflejan esa estructura.
- Acción: excluirlas de análisis generales y derivar una métrica del número de diagnósticos/procedimientos por paciente.

Causa Probable: Estas columnas podrían ser placeholders en la base de datos original, campos que nunca se utilizan, o datos que no se extrajeron correctamente durante el proceso de recopilación.

Acción Inmediata: Al no contener ninguna información, estas columnas deben ser eliminadas del dataset. No aportan valor analítico y solo añaden ruido y complejidad.

2.  Columnas con Alta Tasa de Valores Faltantes (\>90% NA) Existe un segundo grupo de variables, principalmente las relacionadas con diagnósticos y procedimientos secundarios (ej. Diagnóstico 20 hasta Diagnóstico 3), que tienen una tasa de valores faltantes muy alta, aunque no del 100%.

Evidencia: El gráfico vis_miss muestra un patrón claro: la ausencia de datos en Diagnóstico 5, por ejemplo, casi siempre implica la ausencia en Diagnóstico 6 y posteriores.

Interpretación: Esto no es un error, sino una ausencia de datos estructural. Simplemente significa que la mayoría de los pacientes no tienen tantos diagnósticos o procedimientos registrados. Un paciente con solo dos diagnósticos tendrá NA en las columnas Diagnóstico 3 en adelante.

Acción Recomendada: Para la mayoría de los análisis generales, estas columnas con más del 95% de datos faltantes también pueden ser eliminadas. Sin embargo, de este patrón se puede extraer una nueva variable muy útil: un conteo del número total de diagnósticos o procedimientos por paciente, lo que convierte el problema de los datos faltantes en una nueva característica (feature engineering).

3.  Variables Clave con Datos Completos o Casi Completos Afortunadamente, las variables que parecen ser centrales para el análisis están en su mayoría completas.

Evidencia: La parte inferior del gráfico de barras muestra que columnas como Categoría, Comunidad Autónoma, Diagnóstico Principal, Sexo, Edad en Ingreso y Estancia Días tienen muy pocos o ningún valor faltante.

Interpretación: Esta es una excelente noticia. Significa que el núcleo del dataset es robusto y fiable, permitiendo realizar análisis descriptivos y de modelado sin necesidad de técnicas complejas de imputación de datos.

## Duplicados

```{r}
num_duplicadas <- sum(duplicated(SaludMental))
pct_duplicadas <- round(100 * num_duplicadas / num_filas, 2)
cat("Filas duplicadas: ", num_duplicadas, " (", pct_duplicadas, "%)\n", sep = "")

SaludMental %>% filter(duplicated(.)) %>% head(10)
```

### Interpretación

- No se identificaron filas duplicadas; el porcentaje es 0%.
- Cada registro representa un episodio único, lo que confirma la calidad de la extracción original.
- No se requieren pasos adicionales de limpieza relacionados con duplicados.

## Variables numéricas: resúmenes y gráficos

```{r, fig.width = 11, fig.height = 12}
numericas <- SaludMental %>% select(where(is.numeric))
n_num <- ncol(numericas)
cat("Variables numéricas: ", n_num, "\n", sep = "")

summary(numericas)

numericas %>%
  pivot_longer(everything(), names_to = "variable", values_to = "valor") %>%
  ggplot(aes(x = valor)) +
  geom_histogram(bins = 30, fill = "#6C3483", color = "white") +
  facet_wrap(~ variable, scales = "free", ncol = 2) +
  labs(title = "Histogramas variables numéricas", x = NULL, y = "Frecuencia") +
  theme_minimal(base_size = 13)

numericas %>%
  pivot_longer(everything(), names_to = "variable", values_to = "valor") %>%
  ggplot(aes(x = variable, y = valor)) +
  geom_boxplot(fill = "#F39C12") +
  coord_flip() +
  labs(title = "Boxplots variables numéricas", x = "Variable", y = NULL) +
  theme_minimal(base_size = 11)


GGally::ggpairs(
  numericas,
  progress = FALSE,
  columnLabels = colnames(numericas)
)

```

Análisis de Variables Numéricas Se identificaron un total de 13 variables con tipo de dato numérico. Sin embargo, un análisis de su distribución y valores revela que no todas son cuantitativas en la práctica. Podemos clasificarlas en tres grupos distintos.

1.  Variables Cuantitativas Reales Estas variables representan mediciones continuas y son clave para el análisis.

Edad y Edad en Ingreso: Ambas muestran una distribución casi normal, ligeramente sesgada a la derecha, con un pico en torno a los 40-50 años. El summary y el gráfico de pares (ggpairs) confirman que son prácticamente idénticas (correlación de 1.000), lo que indica que una de ellas es redundante y podría eliminarse.

Estancia Días, Coste APR y Peso Español APR: Estos son los ejemplos más claros de variables cuantitativas. Los histogramas muestran que las tres tienen una fuerte asimetría positiva (sesgo a la derecha). Esto es típico en datos de salud: la mayoría de las estancias y costes son bajos, pero hay unos pocos casos extremos (outliers) con valores muy altos. El boxplot de Coste APR visualiza perfectamente esta característica, con una caja compacta y muchos puntos atípicos.

2.  Variables Categóricas Codificadas como Números La mayoría de las variables numéricas en este dataset no son realmente cuantitativas, sino códigos que representan categorías.

Evidencia: Los histogramas para Sexo, Tipo Alta, Nivel Severidad APR, Riesgo Mortalidad APR, GRD APR y CDM APR no muestran una distribución continua, sino barras discretas en valores enteros específicos. Por ejemplo, Sexo se concentra en los valores 1 y 2 (y un valor anómalo en 9), y Nivel Severidad APR en 1, 2, 3 y 4.

Interpretación: Tratar estas variables como números en un modelo (por ejemplo, calculando su media) sería incorrecto. Deben ser convertidas a factores para un análisis adecuado, asignando etiquetas a cada nivel (ej. Sexo: 1 = "Hombre", 2 = "Mujer").

3.  Variables Constantes o Inválidas CIE: El summary y el histograma muestran que esta variable tiene un valor constante de 10 para todos los registros. Al no tener variabilidad, no aporta información analítica y no se puede calcular su correlación con otras variables (por eso aparece como NA en el gráfico ggpairs). Esta columna debería ser eliminada.

Correlaciones y Conclusiones Clave El gráfico de pares (ggpairs) nos permite visualizar las relaciones entre las variables:

Redundancia: Como se mencionó, la correlación perfecta (1.000) entre Edad y Edad en Ingreso confirma que son la misma información.

Relaciones Esperadas: Se observa una correlación positiva, aunque moderada, entre Estancia Días y Coste APR (Corr: 0.231*). Lógicamente, estancias más largas tienden a ser más costosas. De manera similar, Nivel Severidad APR tiene una correlación positiva con Peso Español APR (Corr: 0.251*), indicando que casos más severos están asociados a un mayor peso (y por ende, coste).

Necesidad de Transformación: La forma de "L" en los gráficos de dispersión que involucran a Estancia Días y Coste APR es un síntoma claro de su sesgo. Para algunos modelos predictivos, aplicar una transformación logarítmica a estas variables podría ser beneficioso para normalizar su distribución.

## Variables categóricas: frecuencias y gráficos

```{r}
categoricas <- SaludMental %>% select(where(~ is.character(.x) || is.factor(.x)))
n_cat <- ncol(categoricas)
cat("Variables categóricas: ", n_cat, "\n", sep = "")

vars_interes <- c(
  "Comunidad Autónoma",
  "Nombre",
  "Fecha de Fin Contacto",
  "Diagnóstico Principal",
  "Procedimiento 1",
  "Número de registro anual",
  "Centro Recodificado",
  "País Nacimiento",
  "Mes de Ingreso"
)

categoricas_sel <- categoricas %>% select(all_of(vars_interes))
vars_to_show <- colnames(categoricas_sel)
top_k <- 10

cat("Se grafican ", length(vars_to_show), " variables seleccionadas manualmente.\n", sep = "")
cat("Variables: ", paste(vars_to_show, collapse = ", "), "\n", sep = "")

if (length(vars_to_show) > 0) {
  counts_cat <- categoricas_sel %>%
    pivot_longer(everything(), names_to = "variable", values_to = "valor") %>%
    filter(!is.na(valor)) %>%
    group_by(variable, valor) %>%
    summarise(n = n(), .groups = "drop")

  cat_top <- counts_cat %>%
    group_by(variable) %>%
    slice_max(n, n = top_k, with_ties = FALSE) %>%
    ungroup() %>%
    group_by(variable) %>%
    mutate(valor = forcats::fct_reorder(as.factor(valor), n)) %>%
    ungroup()

  ggplot(cat_top, aes(x = valor, y = n)) +
    geom_col(fill = "#27AE60") +
    coord_flip() +
    facet_wrap(~ variable, scales = "free_y", ncol = 2) +
    labs(
      x = "Categoría",
      y = "Frecuencia",
      title = paste0("Top ", top_k, " categorías por variable (selección manual)")
    ) +
    theme_minimal(base_size = 13)
} else {
  cat("Ninguna de las variables seleccionadas está presente en el dataset.\n")
}
```

### Interpretación

El análisis de las nueve variables categóricas seleccionadas revela cuatro hallazgos principales:

**1. Sesgo geográfico y demográfico**
- `Comunidad Autónoma` está dominada por Andalucía; las conclusiones no se generalizan al resto de España.
- `País Nacimiento` se concentra en el código `724` (España) y un valor residual `ZZZ`.

**2. Perfil clínico dominante**
- `Diagnóstico Principal` se enfoca en códigos CIE-10 del capítulo F, destacando `F20.9`, `F20.0` y `F31.9`.
- `Procedimiento 1` privilegia códigos como `GZZZZZZ` (sin procedimiento) y otros específicos (`B02ZZZZ`, `GZ14ZZZ`).

**3. Identificadores de alta cardinalidad**
- `Nombre`, `Número de registro anual` y `Centro Recodificado` poseen muchos valores únicos; son útiles como identificadores, no para agregaciones.

**4. Variables temporales mal tipificadas**
- `Mes de Ingreso` y `Fecha de Fin Contacto` se almacenan como texto; deben transformarse a formatos de fecha para análisis de tendencias.
## Outliers (regla IQR)

```{r}
  outlier_stats <- numericas %>%
    pivot_longer(everything(), names_to = "variable", values_to = "valor") %>%
    group_by(variable) %>%
    summarise(
      q1 = quantile(valor, 0.25, na.rm = TRUE),
      q3 = quantile(valor, 0.75, na.rm = TRUE),
      iqr = q3 - q1,
      lower = q1 - 1.5 * iqr,
      upper = q3 + 1.5 * iqr,
      n = sum(!is.na(valor)),
      outliers = sum(valor < lower | valor > upper, na.rm = TRUE),
      pct_out = round(100 * outliers / pmax(n, 1), 2)
    ) %>% arrange(desc(pct_out))

  outlier_stats

  top_var <- outlier_stats$variable[1]
  top_pct <- outlier_stats$pct_out[1]
  cat("Mayor % de outliers en: ", top_var, " (", top_pct, "%)\n", sep = "")
```

### Interpretación

El análisis IQR diferencia dos tipos de resultados:

**1. Falsos positivos en códigos categóricos**
- `Circunstancia de Contacto`, `Tipo Alta`, `GRD APR`, `Riesgo Mortalidad APR` y similares aparecen con altos porcentajes de outliers.
- La causa es que el IQR se aplica a columnas de códigos discretos con baja variabilidad (por ejemplo, solo valores 1 y 2).
- Acción: reclasificar estas variables como factores y excluirlas del análisis de outliers.

**2. Outliers reales en métricas cuantitativas**
- `Estancia Días` (5.8%), `Coste APR` (0.9%) y `Peso Español APR` (0.8%) contienen casos extremos auténticos.
- Representan estancias prolongadas y episodios de alto coste; conviene analizarlos detalladamente antes de decidir cualquier tratamiento.
- `Edad` y `Edad en Ingreso` muestran outliers en extremos etarios, coherentes con la distribución.

**Conclusión**  Los outliers validan la necesidad de diferenciar variables categóricas y cuantitativas, y subrayan que los casos extremos en costes y estancias son cruciales para la toma de decisiones clínicas y de gestión.





